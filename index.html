<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quantria Full Featured</title>
<style>
  body {
    background: linear-gradient(135deg, #212121, #282a36 80%);
    color: #fafafa;
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0; padding: 0;
    text-align: center;
  }
  .logo {
    width: 180px;
    margin:30px auto 10px;
    display:block;
    box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  }
  h1 {
    color: #f5d86e;
    text-shadow: 0 2px 12px #3c1a00;
    letter-spacing: 1.8px;
    font-weight: 700;
    margin-bottom: 15px;
  }
  #topbar {
    position: fixed;
    top: 10px;
    right: 15px;
    padding: 10px 15px;
    background: rgba(27, 28, 40, 0.85);
    border-radius: 10px;
    z-index: 100;
  }
  #topbar span, #topbar a {
    margin-left: 12px;
    cursor: pointer;
    background: linear-gradient(90deg,#f5d86e,#bb81e6);
    padding: 5px 10px;
    border-radius: 8px;
    font-weight: 600;
    color: #222;
    text-decoration: none;
  }
  #topbar a:hover {
    background: linear-gradient(90deg,#bb81e6,#f5d86e);
  }
  #authContainer, #linkContainer, #adminControls {
    max-width: 420px;
    margin: 100px auto 30px auto;
    background: #222430;
    border-radius: 12px;
    padding: 25px 20px;
    box-shadow: 0 2px 18px #0005;
  }
  input[type=text] {
    width: 95%;
    padding: 12px;
    margin-bottom: 18px;
    font-size: 1em;
    border: none;
    border-radius: 7px;
    background: #353749;
    color: #eee;
    outline: none;
  }
  button {
    cursor: pointer;
    border-radius: 7px;
    border: none;
    padding: 11px 28px;
    font-weight: 700;
    font-size: 1.1em;
    color: #222;
    background: linear-gradient(90deg,#f5d86e,#bb81e6);
    box-shadow: 0 3px 9px #bb81e630;
    transition: 0.3s background ease;
  }
  button:hover {
    background: linear-gradient(90deg,#bb81e6,#f5d86e);
    color: #1a1a1a;
  }
  #loading, #successMsg {
    margin-top: 12px;
    font-weight: 700;
    text-align: center;
  }
  #loading {
    color: #6ee7b7;
    display: none;
  }
  #successMsg {
    color: #81e6e1;
    display: none;
  }
  #linksList {
    margin-top: 20px;
    text-align: left;
  }
  .link-entry {
    margin-bottom: 12px;
  }
  .link-entry a {
    font-weight: 700;
    font-size: 1.04em;
    color: #bb81e6;
    text-decoration: none;
  }
  .link-entry a:hover {
    color: #f5d86e;
    text-shadow: 0 2px 15px #f5d86e80;
  }
  .uploader {
    font-size: 0.78em;
    color: #ccc;
  }
  .delete-btn {
    margin-left: 10px;
    padding: 3px 7px;
    border-radius: 4px;
    border: none;
    background: #dc2020;
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85em;
  }
  #adminControls {
    display: none;
    max-width: 720px;
    margin: 30px auto;
    background: #242837;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 0 15px #bb81e670;
  }
  #adminLinksList table {
    width: 100%;
    border-collapse: collapse;
    color: white;
  }
  #adminLinksList th, #adminLinksList td {
    text-align: left;
    padding: 10px 8px;
    border-bottom: 1px solid #555;
  }
  #adminLinksList tr:hover {
    background: #3b3479;
  }
  #loadMoreBtn {
    margin-top: 25px;
    background: #bb81e6;
    color: #181628;
    font-weight: 700;
  }
</style>
</head>
<body>

<img src="30904b7b-84ba-4cf2-96ad-30e65b7f0369.jpg" alt="Quantria Logo" class="logo" />
<h1>Quantria</h1>

<div id="topbar" style="display:none;">
  <span id="userLabel"></span>
  <a href="javascript:void(0)" id="enterAdminBtn">Enter as Admin</a>
  <a href="javascript:void(0)" id="exitAdminBtn" style="display:none;">Exit Admin</a>
  <a href="javascript:void(0)" id="darkModeToggle">Toggle Dark Mode</a>
  <a href="javascript:void(0)" id="logoutBtn" style="display:none;">Logout</a>
</div>

<div id="authContainer">
  <button id="loginBtn">Login with Google</button>
  <div id="loginStatus">Not logged in</div>
</div>

<div id="linkContainer" style="display:none;">
  <input type="text" id="linkInput" placeholder="Text, URL or URL only" />
  <button id="addLinkBtn">Add Link</button>
  <button id="searchClearBtn" style="display:none;">Clear Search</button>
  <input type="text" id="searchInput" placeholder="Search by text or user" style="margin-top:12px; display:block; width:95%;"/>
  <div id="loading">Loading...</div>
  <div id="successMsg">Added successfully!</div>

  <div id="linksList"></div>
  <button id="loadMoreBtn" style="display:none;">Load More</button>
</div>

<div id="adminControls" style="display:none;">
  <h2>Admin Dashboard</h2>
  <button id="exportBtn">Export as CSV</button>
  <div id="adminLinksList"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, limit,
    getDocs, deleteDoc, doc, serverTimestamp, startAfter, updateDoc
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBEY7gfueMhxhwz_j9WgRTA9qvzVxmoXBE",
    authDomain: "quantria-b6fc1.firebaseapp.com",
    projectId: "quantria-b6fc1",
    storageBucket: "quantria-b6fc1.firebasestorage.app",
    messagingSenderId: "552646992548",
    appId: "1:552646992548:web:e26196a5ef2e750e453c31",
    measurementId: "G-KYBMBZJ9FQ"
  };

  const ADMIN_PASS = "156";
  const PAGE_SIZE = 50;
  let isAdmin = false;
  let currentUser = null;
  let lastVisibleDoc = null;

  // Elements
  const authContainer = document.getElementById('authContainer');
  const loginBtn = document.getElementById('loginBtn');
  const loginStatus = document.getElementById('loginStatus');

  const linkContainer = document.getElementById('linkContainer');
  const linkInput = document.getElementById('linkInput');
  const addLinkBtn = document.getElementById('addLinkBtn');
  const loading = document.getElementById('loading');
  const successMsg = document.getElementById('successMsg');
  const linksList = document.getElementById('linksList');
  const loadMoreBtn = document.getElementById('loadMoreBtn');

  const adminControls = document.getElementById('adminControls');
  const adminLinksList = document.getElementById('adminLinksList');
  const exportBtn = document.getElementById('exportBtn');

  const topbar = document.getElementById('topbar');
  const userLabel = document.getElementById('userLabel');
  const enterAdminBtn = document.getElementById('enterAdminBtn');
  const exitAdminBtn = document.getElementById('exitAdminBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const searchInput = document.getElementById('searchInput');
  const searchClearBtn = document.getElementById('searchClearBtn');

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // UI Updates
  function updateUI() {
    if (currentUser) {
      userLabel.textContent = `Hello, ${currentUser.displayName}`;
      topbar.style.display = 'block';
      authContainer.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      linkContainer.style.display = 'block';
      loginStatus.textContent = '';
      enterAdminBtn.style.display = 'inline-block';
      exitAdminBtn.style.display = 'none';
      adminControls.style.display = 'none';
      loadMoreBtn.style.display = 'none';
      searchClearBtn.style.display = 'none';
      searchInput.value = '';
    } else {
      userLabel.textContent = '';
      topbar.style.display = 'none';
      authContainer.style.display = 'block';
      logoutBtn.style.display = 'none';
      linkContainer.style.display = 'none';
      loginStatus.textContent = 'Not logged in';
      adminControls.style.display = 'none';
      loadMoreBtn.style.display = 'none';
      searchClearBtn.style.display = 'none';
      searchInput.value = '';
    }
  }

  // Listen for auth state changes
  onAuthStateChanged(auth, user => {
    currentUser = user;
    isAdmin = false;
    updateUI();
    if (user) loadLinks();
  });

  // Login handler
  async function login() {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  }

  // Logout handler
  function logout() {
    signOut(auth);
    isAdmin = false;
    updateUI();
  }

  // Parse input string for text and URL
  function parseLinkInput(inputStr) {
    let text = "",
      url = "";

    if (!inputStr.match(/^https?:\/\//)) {
      if (inputStr.match(/^www\./)) {
        inputStr = "https://" + inputStr;
      } else if (inputStr.indexOf(",") === -1) {
        inputStr = "https://www." + inputStr;
      }
    }

    const parts = inputStr.split(",");
    if (parts.length === 1) {
      url = parts[0].trim();
      text = url;
    } else {
      text = parts.slice(0, parts.length - 1).join(",").trim();
      url = parts[parts.length - 1].trim();
    }
    if (!url.match(/^https?:\/\/.+/)) {
      url = "";
    }
    return {
      text,
      url
    };
  }

  // Add link handler
  async function addLink() {
    if (!currentUser) {
      alert("Please login first");
      return;
    }

    let val = linkInput.value.trim();
    if (!val) {
      alert("Enter 'Text, URL' or 'URL' only");
      return;
    }

    const parsed = parseLinkInput(val);
    if (!parsed.url) {
      alert("Please enter a valid URL");
      return;
    }

    loading.style.display = "block";

    try {
      await addDoc(collection(db, "links"), {
        text: parsed.text,
        url: parsed.url,
        uid: currentUser.uid,
        username: currentUser.displayName,
        timestamp: serverTimestamp()
      });
      successMsg.style.display = "block";
      linkInput.value = "";
      lastVisibleDoc = null;
      loadLinks();
    } catch (err) {
      alert("Error adding link: " + err.message);
    } finally {
      loading.style.display = "none";
      setTimeout(() => (successMsg.style.display = "none"), 3000);
    }
  }

  // Pagination draft variable
  let lastVisibleDoc = null;
  const PAGE_SIZE = 50;

  // Load links with pagination
  async function loadLinks(paginate = false) {
    if (!paginate) {
      linksList.innerHTML = "";
      lastVisibleDoc = null;
      loadMoreBtn.style.display = "none";
    }

    let q;
    if (lastVisibleDoc) {
      q = query(
        collection(db, "links"),
        orderBy("timestamp", "desc"),
        startAfter(lastVisibleDoc),
        limit(PAGE_SIZE)
      );
    } else {
      q = query(collection(db, "links"), orderBy("timestamp", "desc"), limit(PAGE_SIZE));
    }

    const snapshot = await getDocs(q);
    if (snapshot.empty && !lastVisibleDoc) {
      linksList.innerHTML = "<p>No links yet.</p>";
      return;
    }
    lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const docId = docSnap.id;

      const div = document.createElement("div");
      div.className = "link-entry";
      div.innerHTML = `<a href="${data.url}" target="_blank">${data.text}</a><div class="uploader">Uploaded by: ${data.username}</div>`;

      if (currentUser && (currentUser.uid === data.uid || isAdmin)) {
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          try {
            await deleteDoc(doc(db, "links", docId));
            lastVisibleDoc = null;
            loadLinks();
          } catch (err) {
            alert("Error deleting link: " + err.message);
          }
        };
        div.appendChild(delBtn);
      }
      linksList.appendChild(div);
    });

    loadMoreBtn.style.display = snapshot.size === PAGE_SIZE ? "block" : "none";
  }

  // Admin mode handlers
  function adminLogin() {
    const pass = prompt("Enter admin password:");
    if (pass === ADMIN_PASS) {
      isAdmin = true;
      alert("Admin mode enabled");
      adminControls.style.display = "block";
      linkContainer.style.display = "none";
      enterAdminBtn.style.display = "none";
      exitAdminBtn.style.display = "inline-block";
      loadLinks();
    } else {
      alert("Incorrect password.");
    }
  }
  function exitAdminMode() {
    isAdmin = false;
    alert("Admin mode disabled");
    adminControls.style.display = "none";
    linkContainer.style.display = "block";
    enterAdminBtn.style.display = "inline-block";
    exitAdminBtn.style.display = "none";
    loadLinks();
  }

  // Export CSV function
  async function exportLinksCSV() {
    const snapshot = await getDocs(collection(db, "links"));
    if (snapshot.empty) {
      alert("No links to export.");
      return;
    }
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Text,URL,Uploaded By\n";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const row = `"${data.text.replace(/"/g, '""')}","${data.url}","${data.username}"\n`;
      csvContent += row;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "quantria_links.csv");
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  enterAdminBtn.onclick = adminLogin;
  exitAdminBtn.onclick = exitAdminMode;
  logoutBtn.onclick = logout;
  loginBtn.onclick = login;
  addLinkBtn.onclick = addLink;
  loadMoreBtn.onclick = () => loadLinks(true);
  exportBtn.onclick = exportLinksCSV;
  darkModeToggle.onclick = () => document.body.classList.toggle("dark");

  // Optional: Search/filter links by text or username
  searchInput.oninput = () => {
    const keyword = searchInput.value.toLowerCase().trim();
    if (!keyword) {
      searchClearBtn.style.display = "none";
      Array.from(linksList.children).forEach(div => div.style.display = "block");
      return;
    }
    searchClearBtn.style.display = "inline-block";
    Array.from(linksList.children).forEach(div => {
      const text = div.textContent.toLowerCase();
      div.style.display = text.includes(keyword) ? "block" : "none";
    });
  };

  searchClearBtn.onclick = () => {
    searchInput.value = "";
    searchClearBtn.style.display = "none";
    Array.from(linksList.children).forEach(div => div.style.display = "block");
  };

</script>

</body>
</html>
